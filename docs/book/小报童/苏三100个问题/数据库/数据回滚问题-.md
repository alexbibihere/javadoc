# 数据回滚问题-

## **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">前言</font>**
<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">相信很多小伙伴在工作中都遇到过类似的问题：一个操作不小心，或者是误操作，导致重要的数据被删除了。</font>

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">接着就会有一个问题冒出来，“数据误删了，怎么回滚？”</font>

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">今天这篇文章就重点跟大家一起聊聊，误删数据之后，如何恢复的问题，希望对你会有所帮助。</font>

## **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">1. 误删库的恢复</font>**
<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">删除整个数据库（删库）是最严重的操作之一，因为一旦删库，所有的表、数据、索引、视图等都被删除了。如果没有备份，恢复数据的难度就非常大。那么，如果真的不小心删库了，怎么办呢？</font>

**<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">问题分析</font>**

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">假设你执行了以下删除操作：</font>

```plain
DROP DATABASE my_database;
```

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">如果执行了上述命令并且数据库没有备份，你的数据库基本上就没了。</font>

**<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">恢复方法</font>**

1. **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">检查是否开启了二进制日志（binlog）</font>**

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">如果是MySQL数据库，并且你在删除之前有开启二进制日志，那么可以通过binlog来恢复数据。binlog会记录所有对数据库的修改操作，包括DROP DATABASE命令。</font>

    - **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">步骤1</font>**<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">：查看最近的二进制日志。</font>

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">使用mysqlbinlog工具，查看binlog文件。</font>

```plain
mysqlbinlog /var/lib/mysql/mysql-bin.000001 --start-position=12345 --stop-position=67890 > restore.sql
```

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">这条命令会从binlog中提取出一段操作记录，恢复SQL会被保存在restore.sql文件里。</font>

    - **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">步骤2</font>**<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">：恢复数据库</font>

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">你可以手动执行这些SQL语句来恢复误删的数据库和表格。如果binlog中并没有包含DROP DATABASE操作，你只需要重新创建数据库。</font>

```plain
CREATE DATABASE my_database;
SOURCE restore.sql;
```

2. **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">恢复从备份中</font>**

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">如果你有定期的数据库备份（比如使用mysqldump做的备份），恢复操作就相对简单。</font>

    - **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">步骤1</font>**<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">：从备份中恢复</font>

```plain
mysql -u root -p < backup.sql
```

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">这条命令会将备份中的所有数据恢复到新创建的数据库中。</font>

## **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">2. 误删表的恢复</font>**
<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">误删单个表（删表）是比较常见的错误，特别是操作不当，误用了DROP TABLE命令。通常，恢复误删的表需要通过以下几种方式来尝试。</font>

**<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">问题分析</font>**

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">假设你执行了以下删除命令：</font>

```plain
DROP TABLE my_table;
```

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">这时，整个表被删除了，但表的结构和数据都丢失了。</font>

**<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">恢复方法</font>**

1. **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">检查是否开启了表的回滚（Flashback）功能（针对某些数据库，如Oracle）</font>**

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">如果你使用的是像Oracle这样的数据库，它有Flashback功能，可以让你回到某个历史时间点恢复被删除的表。对于误删表的恢复，使用Flashback是最直接的方法。</font>

    - **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">步骤1</font>**<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">：使用FLASHBACK恢复表</font>

```plain
FLASHBACK TABLE my_table TO BEFORE DROP;
```

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">这样就能恢复my_table表，在删除之前的数据状态。</font>

2. **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">通过binlog恢复（针对MySQL）</font>**

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">对于MySQL数据库，如果没有开启binlog，这个方法就不适用了，但如果开启了二进制日志，你可以通过binlog来恢复被删除的表。</font>

    - **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">步骤1</font>**<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">：通过binlog恢复表</font>

```plain
mysqlbinlog /var/lib/mysql/mysql-bin.000001 --start-position=12345 --stop-position=67890 > restore_table.sql
```

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">你需要根据实际的日志位置，提取删除之前的所有操作，并执行恢复操作。</font>

3. **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">通过备份恢复表</font>**

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">如果有定期的数据库备份，恢复误删的表就非常容易。假设你使用了mysqldump做的备份，可以通过以下命令恢复表。</font>

    - **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">步骤1</font>**<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">：从备份中恢复单个表</font>

```plain
mysqldump -u root -p my_database my_table > my_table_backup.sql
mysql -u root -p my_database < my_table_backup.sql
```

4. **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">利用Undrop工具（针对MySQL）</font>**

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">这是MySQL的一个“黑科技”——Undrop工具。虽然MySQL本身没有直接的表恢复机制，但通过一些工具（比如Percona的Undrop），你有机会恢复误删除的表。这个工具通过扫描磁盘上的InnoDB数据文件来恢复表。</font>

## **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">3. 误删数据的恢复</font>**
<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">误删数据的情况稍微好一些，因为它只涉及到单条或多条数据的丢失，不像删库或删表那样一刀切。误删数据可以通过以下几种方式恢复。</font>

**<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">问题分析</font>**

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">假设你执行了以下删除操作：</font>

```plain
DELETE FROM my_table WHERE id = 123;
```

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">你误删了id为123的数据行，想要恢复它。</font>

**<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">恢复方法</font>**

1. **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">检查是否有回滚事务（Transaction）</font>**

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">如果你在执行DELETE语句之前有开启事务，可以通过回滚来恢复数据。</font>

    - **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">步骤1</font>**<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">：如果事务尚未提交，可以直接回滚：</font>

```plain
ROLLBACK;
```

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">这样，事务中的操作就会被撤销，数据恢复。</font>

2. **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">通过binlog恢复（针对MySQL）</font>**

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">如果没有事务，也可以通过binlog来恢复删除的数据。类似表恢复的过程，使用mysqlbinlog提取日志并执行：</font>

    - **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">步骤1</font>**<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">：获取操作日志</font>

```plain
mysqlbinlog /var/lib/mysql/mysql-bin.000001 --start-position=12345 --stop-position=67890 > restore_data.sql
```

    - **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">步骤2</font>**<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">：根据日志恢复数据</font>

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">可以通过手动编写恢复数据的SQL语句，将误删除的数据重新插入表中。</font>

3. **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">使用“软删除”来防止误删除</font>**

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">如果你在设计数据库时使用了“软删除”策略（通过is_deleted字段来标记删除），即使数据被误删，你只需要通过更新该字段即可恢复数据。</font>

```plain
UPDATE my_table SET is_deleted = 0 WHERE id = 123;
```

4. **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">从备份中恢复数据</font>**

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">如果你有定期备份，可以通过备份恢复误删除的数据。这通常是最简单、最可靠的恢复方式。</font>

    - **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">步骤1</font>**<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">：从备份恢复</font>

```plain
mysqldump -u root -p my_database my_table > my_table_backup.sql
mysql -u root -p my_database < my_table_backup.sql
```

5. **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">利用数据恢复软件（如Percona Toolkit）</font>**

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">如果没有备份，也没有开启binlog，但数据块仍然存在，可以尝试使用一些数据恢复工具，例如Percona Toolkit的pt-table-sync，它可以尝试从磁盘恢复已经删除的数据。</font>

### **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">总结</font>**
<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">恢复误删的数据，首先要根据你删除的范围（删库、删表、删数据）来判断使用何种手段。每种情况都有自己的最佳恢复方式：</font>

+ **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">删库</font>**<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">：最依赖的是binlog日志和数据库备份。</font>
+ **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">删表</font>**<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">：可以通过binlog、Flashback（对于Oracle）或者备份来恢复。</font>
+ **<font style="color:rgb(34, 34, 34);background-color:rgb(248, 246, 244);">删数据</font>**<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">：最依赖事务回滚、binlog恢复、以及“软删除”策略。</font>

<font style="color:rgb(51, 51, 51);background-color:rgb(248, 246, 244);">最重要的还是防患于未然，定期做备份，并且在数据库操作时尽量加上一些保护机制，避免误删带来的损失。希望这篇文章能帮到你们！</font>



> 更新: 2025-05-15 19:50:33  
> 原文: <https://www.yuque.com/yuqueyonghue6cvnv/cxhfwd/sh19mq5fdauqw8so>